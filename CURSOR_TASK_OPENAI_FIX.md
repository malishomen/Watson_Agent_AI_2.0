# –ì–õ–û–ë–ê–õ–¨–ù–ê–Ø –ó–ê–î–ê–ß–ê –î–õ–Ø CURSOR AI

–°–¥–µ–ª–∞—Ç—å –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞–±–æ—á—É—é —Å–≤—è–∑–∫—É:

**Telegram-–±–æ—Ç ‚Üí –∫–æ–Ω–≤–µ–µ—Ä (/relay/submit) ‚Üí OpenAI Chat Completions API ‚Üí –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é,**

—Å –Ω–æ—Ä–º–∞–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫, health-check'–æ–º –∏ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º–∏ —Ç–µ—Å—Ç–∞–º–∏.

–†–∞–±–æ—Ç–∞—Ç—å –∏—Ç–µ—Ä–∞—Ç–∏–≤–Ω–æ:
- —Å–∞–º –Ω–∞–π–¥—ë—à—å –≤—Å–µ –Ω—É–∂–Ω—ã–µ —Ñ–∞–π–ª—ã –ø—Ä–æ–µ–∫—Ç–∞,
- —Å–∞–º –ø–æ–ø—Ä–∞–≤–∏—à—å –∫–æ–¥,
- —Å–∞–º –∑–∞–ø—É—Å—Ç–∏—à—å –ª–æ–∫–∞–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ (–ø–æ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏),
- –ù–ï –û–°–¢–ê–ù–ê–í–õ–ò–í–ê–ô–°–Ø –Ω–∞ –ø–µ—Ä–≤–æ–π –æ—à–∏–±–∫–µ ‚Äî –ø—Ä–∞–≤—å –¥–æ —Ç–µ—Ö –ø–æ—Ä, –ø–æ–∫–∞:
  1) –ø—Ä—è–º–æ–π –∑–∞–ø—Ä–æ—Å –∫ OpenAI —á–µ—Ä–µ–∑ backend –ø—Ä–æ—Ö–æ–¥–∏—Ç –±–µ–∑ –æ—à–∏–±–æ–∫,
  2) endpoint –∫–æ–Ω–≤–µ–µ—Ä–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—Å–º—ã—Å–ª–µ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç,
  3) –±–æ—Ç –ø—Ä–∏ —Ç–µ—Å—Ç–æ–≤–æ–º –∑–∞–ø—Ä–æ—Å–µ –æ—Ç–¥–∞—ë—Ç —Ç–µ–∫—Å—Ç –æ—Ç –º–æ–¥–µ–ª–∏ (–∏–ª–∏ –ø–æ–Ω—è—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ).

---

## –¢–ï–•–ù–ò–ß–ï–°–ö–ò–ï –£–°–õ–û–í–ò–Ø

- –ü—Ä–æ–µ–∫—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ–¥ Windows (–ø—É—Ç–∏ –≤–∏–¥–∞ `D:\projects\...`).
- –ö–æ–Ω–≤–µ–µ—Ä —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –≤ –≤–∏–¥–µ backend-—Å–µ—Ä–≤–∏—Å–∞ (FastAPI / Python).
- –ò—Å–ø–æ–ª—å–∑—É–µ–º **–æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π OpenAI API** (`https://api.openai.com/v1/chat/completions` –∏–ª–∏ –Ω–æ–≤—ã–π SDK).
- –ö–ª—é—á OpenAI –±–µ—Ä—ë–º **—Ç–æ–ª—å–∫–æ –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è / –∫–æ–Ω—Ñ–∏–≥–æ–≤**, –≤ –∫–æ–¥ –µ–≥–æ –∂—ë—Å—Ç–∫–æ –Ω–µ –≤—à–∏–≤–∞—Ç—å.
- –¢–µ–∫—É—â–∏–π –ø—Ä–æ–µ–∫—Ç: Watson Agent 2.0
- –ü–æ—Ä—Ç API: 8090
- –û—Å–Ω–æ–≤–Ω–æ–π —Ñ–∞–π–ª API: `api/fastapi_agent.py`

---

## –®–ê–ì 1. –û–ë–ó–û–† –ü–†–û–ï–ö–¢–ê

1. –ü—Ä–æ—Å–∫–∞–Ω–∏—Ä—É–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –∏ –Ω–∞–π–¥–∏:
   - backend/–∫–æ–Ω–≤–µ–µ—Ä: `api/fastapi_agent.py`, `utils/router_core.py`
   - –∫–æ–¥ Telegram-–±–æ—Ç–∞: `api/telegram_bot.py`, `scripts/telegram_bridge.py`
   - –∫–ª–∏–µ–Ω—Ç LLM: `tools/llm_client.py`
   - –æ–±—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ / –∫–æ–Ω—Ñ–∏–≥–∏: `config.toml`, `env.example`, `utils/profile_loader.py`

2. –°–æ—Å—Ç–∞–≤—å –≤–Ω—É—Ç—Ä–µ–Ω–Ω—é—é –∫–∞—Ä—Ç—É:
   - endpoint –∫–æ–Ω–≤–µ–µ—Ä–∞: `/relay/submit` (—É–∂–µ –µ—Å—Ç—å –≤ `api/fastapi_agent.py`)
   - –≥–¥–µ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è –∑–∞–ø—Ä–æ—Å –∫ LLM: `tools/llm_client.py`
   - –≥–¥–µ –ª–µ–∂–∞—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏: `config.toml` + –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

---

## –®–ê–ì 2. –ù–û–†–ú–ê–õ–¨–ù–ê–Ø –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø OPENAI

–ü—Ä–∏–≤–µ–¥–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é OpenAI –∫ –æ–¥–Ω–æ–º—É, –ø–æ–Ω—è—Ç–Ω–æ–º—É –º–µ—Å—Ç—É.

### –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è LM Studio –ª–æ–∫–∞–ª—å–Ω–æ: `http://127.0.0.1:1234/v1`
- –ú–æ–¥–µ–ª–∏: DeepSeek R1 + Qwen 2.5 Coder

### –¢—Ä–µ–±—É–µ—Ç—Å—è:
1. –î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫—É **–Ω–∞—Å—Ç–æ—è—â–µ–≥–æ OpenAI API** (`https://api.openai.com/v1`)
2. –°–æ–∑–¥–∞—Ç—å/–æ–±–Ω–æ–≤–∏—Ç—å –º–æ–¥—É–ª—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:
   ```python
   OPENAI_API_KEY = os.getenv("OPENAI_API_KEY", "")
   OPENAI_BASE_URL = os.getenv("OPENAI_BASE_URL", "https://api.openai.com/v1")
   OPENAI_MODEL = os.getenv("OPENAI_MODEL", "gpt-4o-mini")
   ```

3. –î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é:
   - –µ—Å–ª–∏ `OPENAI_API_KEY` –ø—É—Å—Ç–æ–π –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ OpenAI (–Ω–µ LM Studio) ‚Äî –ø–æ–Ω—è—Ç–Ω–∞—è –æ—à–∏–±–∫–∞

---

## –®–ê–ì 3. –ö–õ–ò–ï–ù–¢ –î–õ–Ø OPENAI (–ï–î–ò–ù–ê–Ø –¢–û–ß–ö–ê –í–•–û–î–ê)

–û–±–Ω–æ–≤–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –º–æ–¥—É–ª—å `tools/llm_client.py`:

### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:

1. **–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –∫–ª–∏–µ–Ω—Ç:**
   - –†–∞–±–æ—Ç–∞–µ—Ç –∏ —Å LM Studio (`http://127.0.0.1:1234/v1`)
   - –†–∞–±–æ—Ç–∞–µ—Ç –∏ —Å OpenAI API (`https://api.openai.com/v1`)
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ø–æ `base_url` –∫–∞–∫–æ–π –ø—Ä–æ–≤–∞–π–¥–µ—Ä –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è

2. **–ò—Å–ø–æ–ª—å–∑—É–π –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π OpenAI SDK:**
   ```python
   from openai import OpenAI
   
   client = OpenAI(
       api_key=api_key or "lm-studio",  # –¥–ª—è LM Studio –º–æ–∂–Ω–æ –ª—é–±–æ–π
       base_url=base_url
   )
   
   def chat(model, messages, temperature=0.2, max_tokens=2048):
       try:
           response = client.chat.completions.create(
               model=model,
               messages=messages,
               temperature=temperature,
               max_tokens=max_tokens
           )
           return response.choices[0].message.content
       except Exception as e:
           logger.error(f"LLM error: {e}")
           raise
   ```

3. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫:**
   - –¢–∞–π–º–∞—É—Ç—ã (timeout=120)
   - 401 (–Ω–µ–≤–µ—Ä–Ω—ã–π –∫–ª—é—á)
   - 429 (rate limits)
   - 5xx (–æ—à–∏–±–∫–∏ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞)

4. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:**
   - –ú–æ–¥–µ–ª—å
   - –î–ª–∏–Ω—É —Å–æ–æ–±—â–µ–Ω–∏–π
   - –ö–æ–¥—ã –æ—à–∏–±–æ–∫ (–ë–ï–ó –ø–æ–ª–Ω–æ–≥–æ –∫–ª—é—á–∞)

---

## –®–ê–ì 4. –≠–ù–î–ü–û–ô–ù–¢ –ö–û–ù–í–ï–ï–†–ê (/relay/submit)

Endpoint –£–ñ–ï –°–£–©–ï–°–¢–í–£–ï–¢ –≤ `api/fastapi_agent.py` (—Å—Ç—Ä–æ–∫–∏ 303-438).

### –¢—Ä–µ–±—É–µ—Ç—Å—è:

1. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ö–µ–º—É –∑–∞–ø—Ä–æ—Å–∞:**
   ```python
   class RelaySubmitIn(BaseModel):
       text: str
       dry_run: bool = False
       chat_id: Optional[str] = None
   ```

2. **–£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π LLM –∫–ª–∏–µ–Ω—Ç:**
   - –ò–º–ø–æ—Ä—Ç: `from tools.llm_client import chat` –∏–ª–∏ `LLMClient`
   - –í—ã–∑–æ–≤ —á–µ—Ä–µ–∑ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å

3. **–£–ª—É—á—à–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É intent "noncode":**
   - –°–µ–π—á–∞—Å –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∑–∞—Ö–∞—Ä–¥–∫–æ–¥–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç
   - –ù—É–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –≤ LLM –¥–ª—è –¥–∏–∞–ª–æ–≥–∞:
   ```python
   if intent == "noncode":
       # –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ OpenAI –¥–ª—è –æ–±—ã—á–Ω–æ–≥–æ —á–∞—Ç–∞
       messages = [
           {"role": "system", "content": "You are a helpful assistant."},
           {"role": "user", "content": body.text}
       ]
       reply = chat(model="gpt-4o-mini", messages=messages)
       return RelaySubmitOut(ok=True, intent="noncode", response=reply)
   ```

4. **–í–æ–∑–≤—Ä–∞—â–∞—Ç—å –æ—Å–º—ã—Å–ª–µ–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏:**
   ```python
   except Exception as e:
       logger.error(f"Relay error: {e}")
       return RelaySubmitOut(
           ok=False,
           intent="error",
           error=f"LLM service unavailable: {str(e)}"
       )
   ```

---

## –®–ê–ì 5. HEALTH-CHECK –î–õ–Ø OPENAI

–î–æ–±–∞–≤—å –≤ `api/fastapi_agent.py` –Ω–æ–≤—ã–π endpoint:

```python
@app.get("/health/openai")
def health_openai():
    """
    –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ OpenAI API.
    –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø—Ä–æ—Å—Ç–æ–π –∑–∞–ø—Ä–æ—Å –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç–∞—Ç—É—Å.
    """
    try:
        from tools.llm_client import chat
        
        messages = [{"role": "user", "content": "ping"}]
        response = chat(
            model=os.getenv("OPENAI_MODEL", "gpt-4o-mini"),
            messages=messages,
            max_tokens=10
        )
        
        return {
            "status": "ok",
            "provider": "openai" if "openai.com" in os.getenv("OPENAI_BASE_URL", "") else "lm-studio",
            "llm_reply": response,
            "model": os.getenv("OPENAI_MODEL", "gpt-4o-mini")
        }
    except Exception as e:
        logger.error(f"OpenAI health check failed: {e}")
        return JSONResponse(
            status_code=503,
            content={
                "status": "error",
                "details": str(e),
                "suggestion": "Check OPENAI_API_KEY and OPENAI_BASE_URL environment variables"
            }
        )
```

---

## –®–ê–ì 6. –ò–ù–¢–ï–ì–†–ê–¶–ò–Ø –° TELEGRAM-–ë–û–¢–û–ú

### –ù–∞–π–¥–∏:
- `api/telegram_bot.py` –∏–ª–∏ `scripts/telegram_bridge.py`
- Handlers –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π

### –¢—Ä–µ–±—É–µ—Ç—Å—è:

1. **–£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –±–æ—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `/relay/submit`:**
   ```python
   async def handle_message(message: Message):
       response = requests.post(
           "http://127.0.0.1:8090/relay/submit",
           json={
               "text": message.text,
               "chat_id": str(message.chat.id),
               "dry_run": False
           },
           timeout=60
       )
       
       if response.ok:
           data = response.json()
           await message.reply(data.get("response", "–ù–µ—Ç –æ—Ç–≤–µ—Ç–∞"))
       else:
           await message.reply(f"‚ö†Ô∏è –û—à–∏–±–∫–∞: {response.status_code}")
   ```

2. **–î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–∞–Ω–¥—É `/ping` –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏:**
   ```python
   @dp.message_handler(commands=['ping'])
   async def cmd_ping(message: Message):
       try:
           # –ü—Ä–æ–≤–µ—Ä–∫–∞ health
           health = requests.get("http://127.0.0.1:8090/health/openai", timeout=10)
           
           if health.ok:
               data = health.json()
               await message.reply(
                   f"‚úÖ OpenAI: {data['status']}\n"
                   f"Provider: {data['provider']}\n"
                   f"Reply: {data['llm_reply']}"
               )
           else:
               await message.reply(f"‚ùå Health check failed: {health.status_code}")
       except Exception as e:
           await message.reply(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å–≤—è–∑–∏: {e}")
   ```

---

## –®–ê–ì 7. –¢–ï–°–¢–´ / –ü–†–û–í–ï–†–ö–ê

–°–æ–∑–¥–∞–π —Ñ–∞–π–ª `tests/test_openai_integration.py`:

```python
import pytest
import os
from tools.llm_client import chat

def test_openai_client():
    """–¢–µ—Å—Ç –ø—Ä—è–º–æ–≥–æ –≤—ã–∑–æ–≤–∞ OpenAI."""
    messages = [{"role": "user", "content": "Say 'test passed' if you can read this"}]
    response = chat(
        model=os.getenv("OPENAI_MODEL", "gpt-4o-mini"),
        messages=messages,
        max_tokens=20
    )
    assert response is not None
    assert len(response) > 0

def test_health_openai():
    """–¢–µ—Å—Ç health-check endpoint."""
    import requests
    response = requests.get("http://127.0.0.1:8090/health/openai", timeout=10)
    assert response.status_code == 200
    data = response.json()
    assert data["status"] == "ok"

def test_relay_submit():
    """–¢–µ—Å—Ç endpoint /relay/submit."""
    import requests
    response = requests.post(
        "http://127.0.0.1:8090/relay/submit",
        json={"text": "ping", "dry_run": False},
        timeout=30
    )
    assert response.status_code == 200
    data = response.json()
    assert data["ok"] is True
    assert "response" in data or "reply" in data
```

–ó–∞–ø—É—Å—Ç–∏:
```bash
py -3.11 -m pytest tests/test_openai_integration.py -v
```

---

## –®–ê–ì 8. –û–ë–†–ê–ë–û–¢–ö–ê –û–®–ò–ë–û–ö –ò –õ–û–ì–ò–†–û–í–ê–ù–ò–ï

–û–±–µ—Å–ø–µ—á—å –≤ `tools/llm_client.py`:

```python
import logging

logger = logging.getLogger(__name__)

def chat(model, messages, **kwargs):
    try:
        logger.info(f"LLM request: model={model}, messages_count={len(messages)}")
        
        response = client.chat.completions.create(
            model=model,
            messages=messages,
            **kwargs
        )
        
        reply = response.choices[0].message.content
        logger.info(f"LLM response: {len(reply)} chars")
        
        return reply
        
    except openai.AuthenticationError as e:
        logger.error(f"Authentication error: Check OPENAI_API_KEY")
        raise
    except openai.RateLimitError as e:
        logger.error(f"Rate limit exceeded: {e}")
        raise
    except openai.APITimeoutError as e:
        logger.error(f"Request timeout: {e}")
        raise
    except Exception as e:
        logger.error(f"Unexpected LLM error: {e}")
        raise
```

**–í–∞–∂–Ω–æ:**
- –ù–ï –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å API –∫–ª—é—á
- –ù–ï –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏–π (—Ç–æ–ª—å–∫–æ –¥–ª–∏–Ω—É)
- –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥—ã –æ—à–∏–±–æ–∫ –∏ —Ç–∏–ø—ã –∏—Å–∫–ª—é—á–µ–Ω–∏–π

---

## –®–ê–ì 9. –ù–ï –û–°–¢–ê–ù–ê–í–õ–ò–í–ê–¢–¨–°–Ø, –ü–û–ö–ê –ù–ï –†–ê–ë–û–¢–ê–ï–¢

–ü—Ä–æ–¥–æ–ª–∂–∞–π —Ä–∞–±–æ—Ç—É, –ø–æ–∫–∞ –Ω–µ –≤—ã–ø–æ–ª–Ω—è—Ç—Å—è –í–°–ï —É—Å–ª–æ–≤–∏—è:

### ‚úÖ Checklist:

- [ ] `tools/llm_client.py` –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç OpenAI API
- [ ] `tools/llm_client.py` –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç LM Studio (backward compatibility)
- [ ] Endpoint `/health/openai` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 200 OK
- [ ] Endpoint `/relay/submit` –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç noncode –∑–∞–ø—Ä–æ—Å—ã —á–µ—Ä–µ–∑ LLM
- [ ] Telegram –±–æ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –≤ `/relay/submit`
- [ ] –ö–æ–º–∞–Ω–¥–∞ `/ping` —Ä–∞–±–æ—Ç–∞–µ—Ç –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç–∞—Ç—É—Å
- [ ] –¢–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç (—Ö–æ—Ç—è –±—ã 2 –∏–∑ 3)
- [ ] –í—Å–µ –æ—à–∏–±–∫–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ
- [ ] API –∫–ª—é—á –Ω–µ –ø–æ–ø–∞–¥–∞–µ—Ç –≤ –ª–æ–≥–∏/–æ—Ç–≤–µ—Ç—ã
- [ ] `env.example` –æ–±–Ω–æ–≤–ª—ë–Ω —Å OpenAI –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:

```powershell
# 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ health
curl http://127.0.0.1:8090/health/openai

# 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ relay
$body = @{ text = "Hello, can you hear me?" } | ConvertTo-Json
curl -X POST http://127.0.0.1:8090/relay/submit `
  -H "Content-Type: application/json" -d $body

# 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ Telegram (–æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –±–æ—Ç—É)
# –î–æ–ª–∂–µ–Ω –æ—Ç–≤–µ—Ç–∏—Ç—å –æ—Å–º—ã—Å–ª–µ–Ω–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º –æ—Ç LLM
```

---

## –®–ê–ì 10. –§–ò–ù–ê–õ–¨–ù–ê–Ø –î–û–ö–£–ú–ï–ù–¢–ê–¶–ò–Ø

–°–æ–∑–¥–∞–π —Ñ–∞–π–ª `OPENAI_INTEGRATION.md` —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º:

### –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ:

1. **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è:**
   ```powershell
   $env:OPENAI_API_KEY = "sk-..."
   $env:OPENAI_BASE_URL = "https://api.openai.com/v1"
   $env:OPENAI_MODEL = "gpt-4o-mini"
   ```

2. **–ó–∞–ø—É—Å–∫ backend:**
   ```powershell
   pwsh scripts/Start-WatsonApi.ps1 -Port 8090
   ```

3. **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã:**
   - Health: `curl http://127.0.0.1:8090/health/openai`
   - Relay: —Å–º. –ø—Ä–∏–º–µ—Ä—ã –≤—ã—à–µ
   - Telegram: –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –±–æ—Ç—É

4. **Troubleshooting:**
   - 401 Unauthorized ‚Üí –ø—Ä–æ–≤–µ—Ä—å OPENAI_API_KEY
   - 503 Service Unavailable ‚Üí LLM –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
   - Connection timeout ‚Üí –ø—Ä–æ–≤–µ—Ä—å OPENAI_BASE_URL

5. **–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É LM Studio –∏ OpenAI:**
   ```powershell
   # LM Studio (–ª–æ–∫–∞–ª—å–Ω–æ)
   $env:OPENAI_BASE_URL = "http://127.0.0.1:1234/v1"
   $env:OPENAI_API_KEY = "lm-studio"
   
   # OpenAI (–æ–±–ª–∞–∫–æ)
   $env:OPENAI_BASE_URL = "https://api.openai.com/v1"
   $env:OPENAI_API_KEY = "sk-..."
   ```

---

## –ò–¢–û–ì–û–í–´–ô –†–ï–ó–£–õ–¨–¢–ê–¢

–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –≤—Å–µ—Ö —à–∞–≥–æ–≤ –¥–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å:

1. ‚úÖ Telegram –±–æ—Ç –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
2. ‚úÖ –ë–æ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–ø—Ä–æ—Å –≤ `/relay/submit`
3. ‚úÖ –ö–æ–Ω–≤–µ–µ—Ä –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç intent (code/noncode/help/etc)
4. ‚úÖ –î–ª—è noncode - –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤ OpenAI Chat API
5. ‚úÖ –ü–æ–ª—É—á–∞–µ—Ç –æ—Ç–≤–µ—Ç –æ—Ç GPT-4o-mini (–∏–ª–∏ –¥—Ä—É–≥–æ–π –º–æ–¥–µ–ª–∏)
6. ‚úÖ –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –≤ Telegram
7. ‚úÖ –í—Å–µ –æ—à–∏–±–∫–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è
8. ‚úÖ Health-check –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç–∞—Ç—É—Å OpenAI

---

## –ê–í–¢–û–ú–ê–¢–ò–ó–ê–¶–ò–Ø (–ë–û–ù–£–°)

–ï—Å–ª–∏ –µ—Å—Ç—å –≤—Ä–µ–º—è, –¥–æ–±–∞–≤—å:

1. **Retry –º–µ—Ö–∞–Ω–∏–∑–º:**
   ```python
   from tenacity import retry, stop_after_attempt, wait_exponential
   
   @retry(stop=stop_after_attempt(3), wait=wait_exponential(multiplier=1, min=2, max=10))
   def chat_with_retry(model, messages, **kwargs):
       return chat(model, messages, **kwargs)
   ```

2. **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Å—Ç—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤:**
   ```python
   from functools import lru_cache
   
   @lru_cache(maxsize=100)
   def cached_simple_reply(text: str) -> str:
       # –î–ª—è FAQ –∏ –ø—Ä–æ—Å—Ç—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤
       pass
   ```

3. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ usage:**
   ```python
   def log_usage(response):
       usage = response.usage
       logger.info(f"Tokens: prompt={usage.prompt_tokens}, completion={usage.completion_tokens}, total={usage.total_tokens}")
   ```

---

## ‚ö° –ù–ê–ß–ù–ò –†–ê–ë–û–¢–£ –ü–†–Ø–ú–û –°–ï–ô–ß–ê–°

Cursor, —Ç—ã –≤–∏–¥–∏—à—å —ç—Ç–æ—Ç —Ñ–∞–π–ª. –ù–∞—á–∏–Ω–∞–π –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–æ —à–∞–≥–∞–º —Å 1 –ø–æ 10.

**–ù–µ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–π—Å—è, –ø–æ–∫–∞ –≤—Å–µ —á–µ–∫–±–æ–∫—Å—ã –≤ –®–ê–ì 9 –Ω–µ –±—É–¥—É—Ç –æ—Ç–º–µ—á–µ–Ω—ã!**

–ï—Å–ª–∏ –≤—Å—Ç—Ä–µ—á–∞–µ—à—å –æ—à–∏–±–∫—É - –∞–Ω–∞–ª–∏–∑–∏—Ä—É–π, –∏—Å–ø—Ä–∞–≤–ª—è–π, —Ç–µ—Å—Ç–∏—Ä—É–π —Å–Ω–æ–≤–∞.

–£–¥–∞—á–∏! üöÄ

---

**"–õ—É—á—à–∏–π –∫–æ–¥ - —ç—Ç–æ –∫–æ–¥, –∫–æ—Ç–æ—Ä—ã–π –Ω–∞–ø–∏—Å–∞–ª –∫—Ç–æ-—Ç–æ –¥—Ä—É–≥–æ–π, –ø–æ–∫–∞ —Ç—ã –ø—å—ë—à—å –∫–æ—Ñ–µ."** ‚òï

