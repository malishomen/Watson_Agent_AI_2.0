#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Cursor Task Sender - ะพัะฟัะฐะฒะบะฐ ะทะฐะดะฐั ะฒ Cursor ัะตัะตะท file-based ัะธััะตะผั
"""
import time, json, os, glob, sys
from pathlib import Path

INBOX = Path(__file__).parent.parent / "inbox"
CURSOR_TASKS = Path(__file__).parent.parent / "cursor_tasks"
PROCESSED = Path(__file__).parent.parent / "data" / "processed_tasks.log"

def init_dirs():
    """ะกะพะทะดะฐะตั ะฝะตะพะฑัะพะดะธะผัะต ะดะธัะตะบัะพัะธะธ"""
    INBOX.mkdir(exist_ok=True)
    CURSOR_TASKS.mkdir(exist_ok=True)
    PROCESSED.parent.mkdir(exist_ok=True)

def log_processed(task_file: str):
    """ะะพะณะธััะตั ะพะฑัะฐะฑะพัะฐะฝะฝัั ะทะฐะดะฐัั"""
    with open(PROCESSED, "a", encoding="utf-8") as f:
        f.write(f"{time.strftime('%Y-%m-%d %H:%M:%S')} - {task_file}\n")

def create_cursor_instruction(task_data: dict, task_id: str) -> str:
    """
    ะกะพะทะดะฐะตั ะดะตัะฐะปัะฝัั ะธะฝััััะบัะธั ะดะปั Cursor AI
    """
    text = task_data.get("text", "")
    repo_path = task_data.get("repo_path", "")
    dry_run = task_data.get("dry_run", False)
    
    instruction = f"""# ๐ฏ ะะะขะะะะขะะงะะกะะะฏ ะะะะะงะ ะะข WATSON AGENT

## ๐ ะะฐะดะฐัะฐ: {task_id}

**ะะฟะธัะฐะฝะธะต:**
{text}

**ะะตะฟะพะทะธัะพัะธะน:**
`{repo_path}`

**ะะตะถะธะผ:** {'๐งช DRY-RUN (ัะพะปัะบะพ ะฟะพะบะฐะทะฐัั diff)' if dry_run else 'โ APPLY (ะฟัะธะผะตะฝะธัั ะธะทะผะตะฝะตะฝะธั)'}

---

## โก ะะะกะขะะฃะะฆะะ ะะะฏ ะะซะะะะะะะะฏ

Cursor AI, ะฒัะฟะพะปะฝะธ ัะปะตะดัััะธะต ัะฐะณะธ:

### 1. ะะฝะฐะปะธะท ะทะฐะดะฐัะธ
- ะัะพัะธัะฐะน ะพะฟะธัะฐะฝะธะต ะทะฐะดะฐัะธ ะฒััะต
- ะะฟัะตะดะตะปะธ ะบะฐะบะธะต ัะฐะนะปั ะฝัะถะฝะพ ะธะทะผะตะฝะธัั
- ะกะฟะปะฐะฝะธััะน ะธะทะผะตะฝะตะฝะธั

### 2. ะะพะธัะบ ัะฐะนะปะพะฒ
- ะะฐะนะดะธ ะฒัะต ัะตะปะตะฒะฐะฝัะฝัะต ัะฐะนะปั ะฒ ัะตะฟะพะทะธัะพัะธะธ
- ะัะพัะธัะฐะน ะธั ัะพะดะตัะถะธะผะพะต
- ะะฟัะตะดะตะปะธ ะณะดะต ะฝัะถะฝั ะธะทะผะตะฝะตะฝะธั

### 3. ะะฝะตัะตะฝะธะต ะธะทะผะตะฝะตะฝะธะน
{'- ะกะพะทะดะฐะน diff ะฟะฐัั ะธ ะะะะะะ ะตะณะพ (ะะ ะฟัะธะผะตะฝัะน!)' if dry_run else '- ะะฝะตัะธ ะธะทะผะตะฝะตะฝะธั ะฒ ัะฐะนะปั'}
{'- ะกะพััะฐะฝะธ diff ะฒ ัะฐะนะป ะดะปั review' if dry_run else '- ะกะพััะฐะฝะธ ะฒัะต ะธะทะผะตะฝะตะฝะฝัะต ัะฐะนะปั'}

### 4. ะัะพะฒะตัะบะฐ
- ะฃะฑะตะดะธัั ััะพ ัะธะฝัะฐะบัะธั ะบะพััะตะบัะตะฝ
- ะัะพะฒะตัั ััะพ ะธะผะฟะพััั ะฝะฐ ะผะตััะต
{'- ะะพะบะฐะถะธ summary ะธะทะผะตะฝะตะฝะธะน' if dry_run else '- ะะฐะฟัััะธ ะปะธะฝัะตั (ะตัะปะธ ะตััั)'}

### 5. ะััะตั
ะกะพะทะดะฐะน ัะฐะนะป `cursor_tasks/task_{task_id}_result.md` ั ะพััะตัะพะผ:
```markdown
# ะะตะทัะปััะฐั ะทะฐะดะฐัะธ {task_id}

## ะะฐะดะฐัะฐ
{text}

## ะัะฟะพะปะฝะตะฝะพ
- [x] ะคะฐะนะป 1: ะพะฟะธัะฐะฝะธะต ะธะทะผะตะฝะตะฝะธะน
- [x] ะคะฐะนะป 2: ะพะฟะธัะฐะฝะธะต ะธะทะผะตะฝะตะฝะธะน

## Diff
```diff
... ัะฒะพะน diff ...
```

## ะกัะฐััั
{'โ Diff ัะพะทะดะฐะฝ, ะณะพัะพะฒ ะบ review' if dry_run else 'โ ะะทะผะตะฝะตะฝะธั ะฟัะธะผะตะฝะตะฝั'}
```

---

## ๐จ ะะะะะ

- ะะฐะฑะพัะฐะน **ัะพะปัะบะพ** ะฒ ัะบะฐะทะฐะฝะฝะพะผ ัะตะฟะพะทะธัะพัะธะธ: `{repo_path}`
- {'**ะะ ะฟัะธะผะตะฝัะน** ะธะทะผะตะฝะตะฝะธั, ัะพะปัะบะพ ะฟะพะบะฐะถะธ diff' if dry_run else 'ะัะธะผะตะฝัะน ะธะทะผะตะฝะตะฝะธั ะฐะบะบััะฐัะฝะพ'}
- ะกะพะทะดะฐะฒะฐะน **ะฟะพะดัะพะฑะฝัะน ะพััะตั** ะพ ะฟัะพะดะตะปะฐะฝะฝะพะน ัะฐะฑะพัะต
- **ะะ ะพััะฐะฝะฐะฒะปะธะฒะฐะนัั** ะฝะฐ ะฟะตัะฒะพะน ะพัะธะฑะบะต - ะฐะฝะฐะปะธะทะธััะน ะธ ะธัะฟัะฐะฒะปัะน

---

**ะะฐัะธะฝะฐะน ะฒัะฟะพะปะฝะตะฝะธะต ะฟััะผะพ ัะตะนัะฐั!** ๐
"""
    return instruction

def process_task(task_file: Path):
    """
    ะะฑัะฐะฑะฐััะฒะฐะตั ะทะฐะดะฐัั ะธะท inbox ะธ ัะพะทะดะฐะตั ะธะฝััััะบัะธั ะดะปั Cursor
    """
    print(f"๐ฅ Processing: {task_file.name}")
    
    try:
        with open(task_file, "r", encoding="utf-8") as f:
            task_data = json.load(f)
        
        task_id = task_file.stem  # task_1234
        
        # ะกะพะทะดะฐะตะผ ะธะฝััััะบัะธั ะดะปั Cursor
        instruction = create_cursor_instruction(task_data, task_id)
        
        # ะกะพััะฐะฝัะตะผ ะฒ cursor_tasks/
        cursor_file = CURSOR_TASKS / f"{task_id}_instruction.md"
        with open(cursor_file, "w", encoding="utf-8") as f:
            f.write(instruction)
        
        print(f"โ ะกะพะทะดะฐะฝะฐ ะธะฝััััะบัะธั: {cursor_file.name}")
        print(f"   ๐ ะัะบัะพะนัะต ัะฐะนะป ะฒ Cursor ะธ ะพัะฟัะฐะฒััะต ะฒ Chat!")
        print(f"   ๐ ะััั: {cursor_file}")
        
        # ะะพะณะธััะตะผ ะพะฑัะฐะฑะพัะบั
        log_processed(task_file.name)
        
        # ะฃะดะฐะปัะตะผ ะทะฐะดะฐัั ะธะท inbox
        task_file.unlink()
        
        return True
        
    except Exception as e:
        print(f"โ Error processing {task_file.name}: {e}")
        return False

def main():
    """
    ะัะฝะพะฒะฝะพะน ัะธะบะป ะผะพะฝะธัะพัะธะฝะณะฐ inbox ะธ ัะพะทะดะฐะฝะธั ะทะฐะดะฐั ะดะปั Cursor
    """
    init_dirs()
    
    print("")
    print("โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ")
    print("   ๐ CURSOR TASK SENDER - ะะะะฃะฉะะ")
    print("โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ")
    print("")
    print(f"๐ Watching: {INBOX.absolute()}")
    print(f"๐ค Output:   {CURSOR_TASKS.absolute()}")
    print(f"๐ Log:      {PROCESSED.absolute()}")
    print("")
    print("๐ก ะะพะณะดะฐ ะทะฐะดะฐัะฐ ะฟะพัะฒะธััั ะฒ inbox:")
    print("   1. ะกะพะทะดะฐะตััั instruction ัะฐะนะป ะฒ cursor_tasks/")
    print("   2. ะัะบัะพะนัะต ัะฐะนะป ะฒ Cursor")
    print("   3. ะัะฟัะฐะฒััะต ะฒะตัั ัะตะบัั ะฒ Cursor Chat (Ctrl+L)")
    print("   4. Cursor ะฒัะฟะพะปะฝะธั ะทะฐะดะฐัั ะฐะฒัะพะผะฐัะธัะตัะบะธ!")
    print("")
    print("โธ๏ธ  ะะฐะถะผะธัะต Ctrl+C ะดะปั ะพััะฐะฝะพะฒะบะธ")
    print("โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ")
    print("")
    
    try:
        while True:
            tasks = sorted(INBOX.glob("*.task.json"))
            
            if tasks:
                print(f"\n๐ ะะฐะนะดะตะฝะพ ะทะฐะดะฐั: {len(tasks)}")
                
            for task_file in tasks:
                process_task(task_file)
                time.sleep(1)  # ะะตะฑะพะปััะฐั ะฟะฐัะทะฐ ะผะตะถะดั ะทะฐะดะฐัะฐะผะธ
            
            time.sleep(2)  # Polling interval
            
    except KeyboardInterrupt:
        print("\n\nโ ะััะฐะฝะพะฒะปะตะฝ ะฟะพะปัะทะพะฒะฐัะตะปะตะผ")
        print("โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ")
        sys.exit(0)

if __name__ == "__main__":
    main()

